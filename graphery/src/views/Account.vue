<template>
  <MaterialPage>
    <div>
      <h3 class="material-page-shorter-h3">
        {{ $t('nav.Account') }}
      </h3>
    </div>
    <div>
      <div id="user-info" class="row">
        <div id="user-info-wrapper" class="col-12 flex-center q-ma-md">
          <UserInfoCard :userObj="userObj" @logout="logout"></UserInfoCard>
        </div>
      </div>
    </div>
  </MaterialPage>
</template>

<script>
  import { apiCaller } from '../services/apis.ts';
  import { logoutMutation } from '../services/queries';
  import { mapState, mapActions } from 'vuex';

  export default {
    components: {
      MaterialPage: () => import('@/components/framework/MaterialPage.vue'),
      UserInfoCard: () => import('@/components/user/UserInfoCard.vue'),
    },
    computed: {
      ...mapState({
        userObj: (state) => state.user,
      }),
    },
    methods: {
      ...mapActions(['setUser']),
      logout() {
        apiCaller(logoutMutation)
          .then(([data, errors]) => {
            if (errors) {
              // TODO add error handling
              console.error(errors);
            }

            if (data && data['logout']['success']) {
              this.setUser(null);
            } else {
              throw Error('Cannot logout at this time');
            }
          })
          .catch((err) => {
            // TODO handle error
            console.log(err);
          });
      },
    },
    watch: {
      userObj: function() {
        if (this.userObj === null) {
          this.$router.push('/login');
        }
      },
    },
  };
</script>
